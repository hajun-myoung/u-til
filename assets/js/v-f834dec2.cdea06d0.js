(self.webpackChunkuntil=self.webpackChunkuntil||[]).push([[496],{1172:(n,s,a)=>{"use strict";a.r(s),a.d(s,{data:()=>e});const e={key:"v-f834dec2",path:"/tech/aws/s3/til.html",title:"Problem Shooting",lang:"ko-KR",frontmatter:{},excerpt:"",headers:[{level:2,title:"Sep 14",slug:"sep-14",children:[{level:3,title:"Permissions Policy를 수정해서 권한 관리하기 SOLVED",slug:"permissions-policy를-수정해서-권한-관리하기-solved",children:[]},{level:3,title:"해결 방법",slug:"해결-방법",children:[]},{level:3,title:"결과",slug:"결과",children:[]}]}],filePathRelative:"tech/aws/s3/til.md",git:{updatedTime:1694740897e3}}},9303:(n,s,a)=>{"use strict";a.r(s),a.d(s,{default:()=>m});var e=a(6252);const p=(0,e.uE)('<h1 id="problem-shooting" tabindex="-1"><a class="header-anchor" href="#problem-shooting" aria-hidden="true">#</a> Problem Shooting</h1><h2 id="sep-14" tabindex="-1"><a class="header-anchor" href="#sep-14" aria-hidden="true">#</a> Sep 14</h2><h3 id="permissions-policy를-수정해서-권한-관리하기-solved" tabindex="-1"><a class="header-anchor" href="#permissions-policy를-수정해서-권한-관리하기-solved" aria-hidden="true">#</a> Permissions Policy를 수정해서 권한 관리하기 <code>SOLVED</code></h3><ul><li>Goal <ul><li>모든 사용자의 Get Object 허용</li><li>특정 사용자의 Put Object 허용</li><li>특정 사용자 외의 Put Object 거부</li></ul></li></ul><h3 id="해결-방법" tabindex="-1"><a class="header-anchor" href="#해결-방법" aria-hidden="true">#</a> 해결 방법</h3><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n  <span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;Principal&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s3:GetObject&quot;</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;arn:aws:s3:::MY_BUCKETS_NAME/&quot;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Deny&quot;</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;NotPrincipal&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">&quot;AWS&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n          <span class="token string">&quot;arn:aws:iam::NUMERICAL_IAM_NUMBER:root&quot;</span><span class="token punctuation">,</span>\n          <span class="token string">&quot;arn:aws:iam::NUMERICAL_IAM_NUMBER:user/USERNAME&quot;</span>\n        <span class="token punctuation">]</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s3:PutObject&quot;</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;arn:aws:s3:::MY_BUCKETS_NAME/*&quot;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div>',6),t=(0,e.Wm)("li",null,[(0,e.Wm)("p",null,"Publicy Accessable로 설정해 기본적으로 모든 요청을 허용")],-1),o=(0,e.Wm)("li",null,[(0,e.Wm)("p",null,[(0,e.Wm)("code",null,"Action: s3:GetObject"),(0,e.Uk)("에 대해서 모두 허용하는 규칙 명시")])],-1),l=(0,e.Wm)("p",null,[(0,e.Wm)("code",null,"Action: s3:PutObject"),(0,e.Uk)("에 대해서 특정 사용자 외의 거부 규칙 명시")],-1),c=(0,e.Wm)("li",null,[(0,e.Uk)("이 때, "),(0,e.Wm)("code",null,"NotPrincipal"),(0,e.Uk)(" 옵션을 사용해서 "),(0,e.Wm)("strong",null,"PutObject Deny"),(0,e.Uk)(" Policy를 "),(0,e.Wm)("em",null,"적용하지 않을"),(0,e.Uk)(" 사용자를 명시")],-1),u=(0,e.Uk)("IAM"),r=(0,e.Uk)(" 사용자를 새로 하나 생성하고, S3 Full Access 권한을 허용해준 뒤"),i=(0,e.Wm)("li",null,"해당 IAM 유저의 AWS_ACCESS_KEY_ID와 AWS_SECRET_ACCESS_KEY를 사용",-1),b=(0,e.Wm)("li",null,"IAM User Number(Numerical)와 IAM User Name을 Policy에 명시함",-1),k=(0,e.uE)('<h3 id="결과" tabindex="-1"><a class="header-anchor" href="#결과" aria-hidden="true">#</a> 결과</h3><p>S3 Storage에 접근하여 객체를 쓰는 서버는 Python 기반으로 작성되었기 때문에 <em>boto3</em> 라이브러리를 사용함</p><ol><li><p><code>.env</code> 파일에 명시되어 있는 <strong>AWS_ACCESS_KEY_ID</strong>와 <strong>AWS_SECRET_ACCESS_KEY</strong>를 할당한 클라이언트 객체는 <strong><em>PutObject 요청 성공</em></strong></p></li><li><p>그렇지 않은 객체는 <strong><em>PutObject 요청 거부됨</em></strong></p></li></ol><ul><li>즉, 모든 사용자가 S3 Storage에 업로드 된 객체(이 경우 영상)를 볼 수 있지만</li><li>특정 사용자만 S3 Storage에 새로운 객체를 업로드할 수 있음 <ul><li>이 &quot;특정 사용자&quot;는 적절한 키를 가지고 있는 서버가 됨</li></ul></li></ul><details class="custom-container details"><summary>업로드 허용 테스트</summary><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> boto3\n\nload_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nAWS_ACCESS_KEY_ID <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&quot;AWS_ACCESS_KEY_ID&quot;</span><span class="token punctuation">)</span>\nAWS_SECRET_ACCESS_KEY <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&quot;AWS_SECRET_ACCESS_KEY&quot;</span><span class="token punctuation">)</span>\n\ns3_client <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span>\n    <span class="token string">&#39;s3&#39;</span><span class="token punctuation">,</span>\n    aws_access_key_id<span class="token operator">=</span>AWS_ACCESS_KEY_ID<span class="token punctuation">,</span>\n    aws_secret_access_key<span class="token operator">=</span>AWS_SECRET_ACCESS_KEY\n<span class="token punctuation">)</span>\n\n<span class="token comment"># ... 중략 ...</span>\n\n<span class="token keyword">def</span> <span class="token function">videoAnalyser</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># ... 중략 ...</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        s3_client<span class="token punctuation">.</span>upload_file<span class="token punctuation">(</span>outFilename<span class="token punctuation">,</span> bucketname<span class="token punctuation">,</span> objecetName<span class="token punctuation">,</span>\n            ExtraArgs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&#39;ContentType&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;video/mp4&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Success to upload to S3 Storage&quot;</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to upload to S3 Storage&quot;</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>Result:</p><div class="language-txt ext-txt line-numbers-mode"><pre class="language-txt"><code>[INFO]001_10.mp4 has been uploaded\nstart to analyse 001_10.mp4\nVideo has been loaded.\nvideo Framesize 1920.0px * 1080.0px\nvideo FPS 29.97 FPS\nvideo Frames 593.0 frames\nINFO: Created TensorFlow Lite XNNPACK delegate for CPU.\nSuccess to upload to S3 Storage / 593.0\n</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlight-line"> </div></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></details><details class="custom-container details"><summary>업로드 거부 테스트</summary><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> boto3\n\nload_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nAWS_ACCESS_KEY_ID <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&quot;AWS_ACCESS_KEY_ID&quot;</span><span class="token punctuation">)</span>\nAWS_SECRET_ACCESS_KEY <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&quot;AWS_SECRET_ACCESS_KEY&quot;</span><span class="token punctuation">)</span>\n\ns3_client <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span>\n    <span class="token string">&#39;s3&#39;</span><span class="token punctuation">,</span>\n    <span class="token comment"># aws_access_key_id=AWS_ACCESS_KEY_ID,</span>\n    <span class="token comment"># aws_secret_access_key=AWS_SECRET_ACCESS_KEY</span>\n<span class="token punctuation">)</span>\n\n<span class="token comment"># ... 중략 ...</span>\n\n<span class="token keyword">def</span> <span class="token function">videoAnalyser</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># ... 중략 ...</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        s3_client<span class="token punctuation">.</span>upload_file<span class="token punctuation">(</span>outFilename<span class="token punctuation">,</span> bucketname<span class="token punctuation">,</span> objecetName<span class="token punctuation">,</span>\n            ExtraArgs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&#39;ContentType&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;video/mp4&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Success to upload to S3 Storage&quot;</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to upload to S3 Storage&quot;</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>Result:</p><div class="language-txt ext-txt line-numbers-mode"><pre class="language-txt"><code>[INFO]001_10.mp4 has been uploaded\nstart to analyse 001_10.mp4\nVideo has been loaded.\nvideo Framesize 1920.0px * 1080.0px\nvideo FPS 29.97 FPS\nvideo Frames 593.0 frames\nINFO: Created TensorFlow Lite XNNPACK delegate for CPU.\nFailed to upload to S3 Storage / 593.0\n</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlight-line"> </div></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></details>',6),m={render:function(n,s){const a=(0,e.up)("RouterLink");return(0,e.wg)(),(0,e.j4)(e.HY,null,[p,(0,e.Wm)("ul",null,[t,o,(0,e.Wm)("li",null,[l,(0,e.Wm)("ul",null,[c,(0,e.Wm)("li",null,[(0,e.Wm)(a,{to:"/tech/aws/iam/"},{default:(0,e.w5)((()=>[u])),_:1}),r]),i,b])])]),k],64)}}}}]);